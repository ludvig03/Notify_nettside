import{Primitive as e,bounds as t,PropertyType as n,BufferUtils as r,Root as o,Texture as s,ExtensionProperty as i,ImageUtils as a,MathUtils as c,Node as l,AnimationChannel as g,Scene as u,Accessor as f,AnimationSampler as p,Material as m,TextureChannel as d,uuid as h}from"@gltf-transform/core";export{bounds}from"@gltf-transform/core";import{getPixels as A,savePixels as y}from"ndarray-pixels";import{MeshQuantization as E,DracoMeshCompression as T,MeshGPUInstancing as S,MeshoptCompression as I,MaterialsIOR as b,MaterialsSpecular as w,MaterialsPBRSpecularGlossiness as N,TextureWebP as M,MaterialsUnlit as R}from"@gltf-transform/extensions";import{invert as O,fromRotationTranslationScale as C,fromScaling as P,multiply as x}from"gl-matrix/mat4";import{transformMat4 as z,min as $,scale as v,max as L,normalize as _}from"gl-matrix/vec3";import q from"ndarray";import{lanczos3 as G,lanczos2 as k}from"ndarray-lanczos";function B(){return(B=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function F(e,t){return Object.defineProperty(t,"name",{value:e}),t}function U(e,t,n){return!!e&&e.stack.lastIndexOf(t)<e.stack.lastIndexOf(n)}async function W(e,t,n){if(!e)return null;const r=e.getImage();if(!r)return null;const o=await A(r,e.getMimeType());for(let e=0;e<o.shape[0];++e)for(let t=0;t<o.shape[1];++t)n(o,e,t);const s=await y(o,"image/png");return t.setImage(s).setMimeType("image/png")}class H{constructor(){this._map=new Map}get size(){return this._map.size}has(e){return this._map.has(e)}add(e,t){let n=this._map.get(e);return n||(n=new Set,this._map.set(e,n)),n.add(t),this}get(e){return this._map.get(e)||new Set}keys(){return this._map.keys()}}function j(e,t=2){if(0===e)return"0 Bytes";const n=t<0?0:t,r=Math.floor(Math.log(e)/Math.log(1e3));return parseFloat((e/Math.pow(1e3,r)).toFixed(n))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][r]}function V(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function D(e,t){return`${V(e)} → ${V(t)} (${function(e,t,n=2){return(e>t?"–":"+")+(Math.abs(e-t)/e*100).toFixed(n)+"%"}(e,t)})`}function X(e){const t=[];for(const n of e.listAttributes())t.push(n);for(const n of e.listTargets())for(const e of n.listAttributes())t.push(e);return Array.from(new Set(t))}function K(e,t,n){e.swap(t,n);for(const r of e.listTargets())r.swap(t,n)}function J(e,t,n){const r=e.getElementSize(),o=e.getCount(),s=e.getArray(),i=s.slice(0,n*r);for(let e=0;e<o;e++)for(let n=0;n<r;n++)i[t[e]*r+n]=s[e*r+n];e.setArray(i)}function Z(e,t=e){const n=t<=65534?new Uint16Array(e):new Uint32Array(e);for(let e=0;e<n.length;e++)n[e]=e;return n}const Q={pivot:"center"};function Y(e=Q){const n=B({},Q,e);return F("center",e=>{const r=e.getLogger(),o=e.getRoot(),s=o.listAnimations().length>0||o.listSkins().length>0;e.getRoot().listScenes().forEach((i,a)=>{let c;if(r.debug(`center: Scene ${a+1} / ${o.listScenes().length}.`),"string"==typeof n.pivot){const e=t(i);c=[(e.max[0]-e.min[0])/2+e.min[0],(e.max[1]-e.min[1])/2+e.min[1],(e.max[2]-e.min[2])/2+e.min[2]],"above"===n.pivot&&(c[1]=e.max[1]),"below"===n.pivot&&(c[1]=e.min[1])}else c=n.pivot;r.debug(`center: Pivot "${c.join(", ")}".`);const l=[-1*c[0],-1*c[1],-1*c[2]];if(s){r.debug("center: Model contains animation or skin. Adding a wrapper node.");const t=e.createNode("Pivot").setTranslation(l);i.listChildren().forEach(e=>t.addChild(e)),i.addChild(t)}else r.debug("center: Skipping wrapper, offsetting all root nodes."),i.listChildren().forEach(e=>{const t=e.getTranslation();e.setTranslation([t[0]+l[0],t[1]+l[1],t[2]+l[2]])})}),r.debug("center: Complete.")})}const ee="colorspace";function te(e){return F(ee,t=>{const n=t.getLogger();if("linear"===e.inputEncoding)return void n.info(`${ee}: Vertex colors already linear. Skipping conversion.`);if("sRGB"!==e.inputEncoding)return void n.error(`${ee}: Unknown input encoding "${e.inputEncoding}" – should be "sRGB" or "linear". Skipping conversion.`);const r=new Set;function o(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function s(e){const t=[0,0,0];let n;for(let s=0;n=e.getAttribute(`COLOR_${s}`);s++)if(!r.has(n)){for(let e=0;e<n.getCount();e++)n.getElement(e,t),t[0]=o(t[0]),t[1]=o(t[1]),t[2]=o(t[2]),n.setElement(e,t);r.add(n)}}t.getRoot().listMeshes().forEach(e=>e.listPrimitives().forEach(s)),n.debug(`${ee}: Complete.`)})}const ne={propertyTypes:[n.ACCESSOR,n.MESH,n.TEXTURE,n.MATERIAL]},re=function(e=ne){const t=B({},ne,e),s=new Set(t.propertyTypes);for(const e of t.propertyTypes)if(!ne.propertyTypes.includes(e))throw new Error(`dedup: Unsupported deduplication on type "${e}".`);return F("dedup",e=>{const t=e.getLogger();s.has(n.ACCESSOR)&&function(e,t){const n=new Set,o=new Set,s=new Set,i=new Set,a=t.getRoot().listMeshes();a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(e=>o.add(e));const t=e.getIndices();t&&n.add(t)})});for(const e of t.getRoot().listAnimations())for(const t of e.listSamplers()){const e=t.getInput(),n=t.getOutput();e&&s.add(e),n&&i.add(n)}function c(e){const t=new Map;for(let n=0;n<e.length;n++){const o=e[n],s=r.toView(o.getArray());if(!t.has(o))for(let n=0;n<e.length;n++){const i=e[n];o!==i&&(t.has(i)||o.getType()===i.getType()&&o.getComponentType()===i.getComponentType()&&o.getCount()===i.getCount()&&o.getNormalized()===i.getNormalized()&&r.equals(s,r.toView(i.getArray()))&&t.set(i,o))}}return t}const l=c(Array.from(n));e.debug(`dedup: Found ${l.size} duplicates among ${n.size} indices.`);const g=c(Array.from(o));e.debug(`dedup: Found ${g.size} duplicates among ${o.size} attributes.`);const u=c(Array.from(s)),f=c(Array.from(i));e.debug(`dedup: Found ${u.size+f.size} duplicates among ${s.size+i.size} animation accessors.`),a.forEach(e=>{e.listPrimitives().forEach(e=>{e.listAttributes().forEach(t=>{g.has(t)&&e.swap(t,g.get(t))});const t=e.getIndices();t&&l.has(t)&&e.swap(t,l.get(t))})}),Array.from(l.keys()).forEach(e=>e.dispose()),Array.from(g.keys()).forEach(e=>e.dispose());for(const e of t.getRoot().listAnimations())for(const t of e.listSamplers()){const e=t.getInput(),n=t.getOutput();e&&u.has(e)&&t.swap(e,u.get(e)),n&&f.has(n)&&t.swap(n,f.get(n))}Array.from(u.keys()).forEach(e=>e.dispose()),Array.from(f.keys()).forEach(e=>e.dispose())}(t,e),s.has(n.MESH)&&function(e,t){const r=t.getRoot(),o=new Map;r.listAccessors().forEach((e,t)=>o.set(e,t)),r.listMaterials().forEach((e,t)=>o.set(e,t));const s=r.listMeshes().length,i=new Map;for(const e of r.listMeshes()){const t=[];for(const n of e.listPrimitives())t.push(oe(n,o));const r=t.join(";");if(i.has(r)){const t=i.get(r);e.listParents().forEach(r=>{r.propertyType!==n.ROOT&&r.swap(e,t)}),e.dispose()}else i.set(r,e)}e.debug(`dedup: Found ${s-i.size} duplicates among ${s} meshes.`)}(t,e),s.has(n.TEXTURE)&&function(e,t){const n=t.getRoot(),s=n.listTextures(),i=new Map;for(let e=0;e<s.length;e++){const t=s[e],n=t.getImage();if(!i.has(t))for(let e=0;e<s.length;e++){const o=s[e],a=o.getImage();if(t===o)continue;if(i.has(o))continue;if(t.getMimeType()!==o.getMimeType())continue;const c=t.getSize(),l=o.getSize();c&&l&&c[0]===l[0]&&c[1]===l[1]&&n&&a&&r.equals(n,a)&&i.set(o,t)}}e.debug(`dedup: Found ${i.size} duplicates among ${n.listTextures().length} textures.`),Array.from(i.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof o||n.swap(e,t)}),e.dispose()})}(t,e),s.has(n.MATERIAL)&&function(e,t){const n=t.getRoot(),r=n.listMaterials(),s=new Map,i=new Set(["name"]);for(let e=0;e<r.length;e++){const t=r[e];if(!s.has(t))for(let e=0;e<r.length;e++){const n=r[e];t!==n&&(s.has(n)||t.equals(n,i)&&s.set(n,t))}}e.debug(`dedup: Found ${s.size} duplicates among ${n.listMaterials().length} materials.`),Array.from(s.entries()).forEach(([e,t])=>{e.listParents().forEach(n=>{n instanceof o||n.swap(e,t)}),e.dispose()})}(t,e),t.debug("dedup: Complete.")})};function oe(t,n){const r=[];for(const e of t.listSemantics()){const o=t.getAttribute(e);r.push(e+":"+n.get(o))}if(t instanceof e){const e=t.getIndices();e&&r.push("indices:"+n.get(e));const o=t.getMaterial();o&&r.push("material:"+n.get(o)),r.push("mode:"+t.getMode());for(const e of t.listTargets())r.push("target:"+oe(e,n))}return r.join(",")}const se={pattern:/^((?!JOINTS_).)*$/};function ie(e=se){const t=B({},se,e);return F("dequantize",e=>{const n=e.getLogger();for(const n of e.getRoot().listMeshes())for(const e of n.listPrimitives())ae(e,t);e.createExtension(E).dispose(),n.debug("dequantize: Complete.")})}function ae(e,t){for(const n of e.listSemantics())ce(n,e.getAttribute(n),t);for(const n of e.listTargets())for(const e of n.listSemantics())ce(e,n.getAttribute(e),t)}function ce(e,t,n){if(!t.getArray())return;if(!n.pattern.test(e))return;if(t.getComponentSize()>=4)return;const r=t.getArray(),o=new Float32Array(r.length);for(let e=0,n=t.getCount(),s=[];e<n;e++)s=t.getElement(e,s),t.setArray(o).setElement(e,s).setArray(r);t.setArray(o).setNormalized(!1)}const le={method:"edgebreaker",encodeSpeed:5,decodeSpeed:5,quantizePosition:14,quantizeNormal:10,quantizeColor:8,quantizeTexcoord:12,quantizeGeneric:12,quantizationVolume:"mesh"},ge=e=>{const t=B({},le,e);return e=>{e.createExtension(T).setRequired(!0).setEncoderOptions({method:"edgebreaker"===t.method?T.EncoderMethod.EDGEBREAKER:T.EncoderMethod.SEQUENTIAL,encodeSpeed:t.encodeSpeed,decodeSpeed:t.decodeSpeed,quantizationBits:{POSITION:t.quantizePosition,NORMAL:t.quantizeNormal,COLOR:t.quantizeColor,TEX_COORD:t.quantizeTexcoord,GENERIC:t.quantizeGeneric},quantizationVolume:t.quantizationVolume})}};function ue(e){return{scenes:fe(e),meshes:pe(e),materials:me(e),textures:de(e),animations:he(e)}}function fe(e){return{properties:e.getRoot().listScenes().map(e=>{const n=e.listChildren()[0],r=t(e);return{name:e.getName(),rootName:n?n.getName():"",bboxMin:Ee(r.min),bboxMax:Ee(r.max)}})}}function pe(t){return{properties:t.getRoot().listMeshes().map(t=>{const r=t.listParents().filter(e=>e.propertyType!==n.ROOT).length;let o=0,s=0;const i=new Set,a=new Set,c=new Set;t.listPrimitives().forEach(t=>{for(const e of t.listSemantics()){const n=t.getAttribute(e);i.add(e+":"+Te(n)),c.add(n)}for(const e of t.listTargets())e.listAttributes().forEach(e=>c.add(e));const n=t.getIndices();n&&(a.add(Te(n)),c.add(n)),s+=t.listAttributes()[0].getCount(),o+=function(t){const n=t.getIndices(),r=t.getAttribute("POSITION");switch(t.getMode()){case e.Mode.POINTS:return r.getCount();case e.Mode.LINES:return n?n.getCount()/2:r.getCount()/2;case e.Mode.LINE_LOOP:return r.getCount();case e.Mode.LINE_STRIP:return r.getCount()-1;case e.Mode.TRIANGLES:return n?n.getCount()/3:r.getCount()/3;case e.Mode.TRIANGLE_STRIP:case e.Mode.TRIANGLE_FAN:return r.getCount()-2;default:throw new Error("Unexpected mode: "+t.getMode())}}(t)});let l=0;Array.from(c).forEach(e=>l+=e.getArray().byteLength);const g=t.listPrimitives().map(e=>Ae[e.getMode()]);return{name:t.getName(),mode:Array.from(new Set(g)),primitives:t.listPrimitives().length,glPrimitives:o,vertices:s,indices:Array.from(a).sort(),attributes:Array.from(i).sort(),instances:r,size:l}})}}function me(e){return{properties:e.getRoot().listMaterials().map(t=>{const r=t.listParents().filter(e=>e.propertyType!==n.ROOT).length,o=new Set(t.listExtensions()),a=e.getGraph().listEdges().filter(e=>{const n=e.getChild(),r=e.getParent();return n instanceof s&&r===t||!!(n instanceof s&&r instanceof i&&o.has(r))}).map(e=>e.getName());return{name:t.getName(),instances:r,textures:a,alphaMode:t.getAlphaMode(),doubleSided:t.getDoubleSided()}})}}function de(e){return{properties:e.getRoot().listTextures().map(t=>{const r=t.listParents().filter(e=>e.propertyType!==n.ROOT).length,o=e.getGraph().listParentEdges(t).filter(e=>e.getParent().propertyType!==n.ROOT).map(e=>e.getName()),s=a.getSize(t.getImage(),t.getMimeType());return{name:t.getName(),uri:t.getURI(),slots:Array.from(new Set(o)),instances:r,mimeType:t.getMimeType(),resolution:s?s.join("x"):"",size:t.getImage().byteLength,gpuSize:a.getMemSize(t.getImage(),t.getMimeType())}})}}function he(e){return{properties:e.getRoot().listAnimations().map(e=>{let t=Infinity,n=-Infinity;e.listSamplers().forEach(e=>{const r=e.getInput();r&&(t=Math.min(t,r.getMin([])[0]),n=Math.max(n,r.getMax([])[0]))});let r=0,o=0;const s=new Set;return e.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&(o+=t.getCount(),s.add(t),n&&s.add(n))}),Array.from(s).forEach(e=>{r+=e.getArray().byteLength}),{name:e.getName(),channels:e.listChannels().length,samplers:e.listSamplers().length,duration:Math.round(1e3*(n-t))/1e3,keyframes:o,size:r}})}}const Ae=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"],ye={Float32Array:"f32",Uint32Array:"u32",Uint16Array:"u16",Uint8Array:"u8",Int32Array:"i32",Int16Array:"i16",Int8Array:"i8"};function Ee(e){for(let t=0;t<e.length;t++)e[t].toFixed&&(e[t]=Number(e[t].toFixed(5)));return e}function Te(e){const t=e.getArray();return(ye[t.constructor.name]||"?")+(e.getNormalized()?"_norm":"")}const Se={};function Ie(e=Se){return B({},Se,e),F("instance",e=>{const t=e.getLogger(),n=e.getRoot(),r=e.createExtension(S);if(n.listAnimations().length)throw new Error("instance: Instancing is not currently supported for animated models.");let o=0,s=0;for(const i of n.listScenes()){const n=new Map;i.traverse(e=>{const t=e.getMesh();t&&n.set(t,(n.get(t)||new Set).add(e))});const a=[];for(const l of Array.from(n.keys())){const g=Array.from(n.get(l));if(g.length<2)continue;if(g.some(e=>e.getSkin()))continue;const u=we(e,r,l,g.length),f=u.getAttribute("TRANSLATION"),p=u.getAttribute("ROTATION"),m=u.getAttribute("SCALE"),d=e.createNode().setMesh(l).setExtension("EXT_mesh_gpu_instancing",u);i.addChild(d);let h=!1,A=!1,y=!1;for(let e=0;e<g.length;e++){let t,n,r;const o=g[e];f.setElement(e,t=o.getWorldTranslation()),p.setElement(e,n=o.getWorldRotation()),m.setElement(e,r=o.getWorldScale()),c.eq(t,[0,0,0])||(h=!0),c.eq(n,[0,0,0,1])||(A=!0),c.eq(r,[1,1,1])||(y=!0),o.setMesh(null),a.push(o)}h||f.dispose(),A||p.dispose(),y||m.dispose(),be(a,t),o++,s+=g.length}}o>0?t.info(`instance: Created ${o} batches, with ${s} total instances.`):(t.info("instance: No meshes with multiple parent nodes were found."),r.dispose()),t.debug("instance: Complete.")})}function be(e,t){let n,r=0;for(;n=e.pop();){if(n.listChildren().length||n.getCamera()||n.getMesh()||n.getSkin()||n.listExtensions().length)continue;const t=n.getParent();t instanceof l&&e.push(t),n.dispose(),r++}t.debug(`instance: Removed ${r} unused nodes.`)}function we(e,t,n,r){const o=n.listPrimitives()[0].getAttribute("POSITION").getBuffer(),s=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*r)).setBuffer(o),i=e.createAccessor().setType("VEC4").setArray(new Float32Array(4*r)).setBuffer(o),a=e.createAccessor().setType("VEC3").setArray(new Float32Array(3*r)).setBuffer(o);return t.createInstancedMesh().setAttribute("TRANSLATION",s).setAttribute("ROTATION",i).setAttribute("SCALE",a)}const Ne={propertyTypes:[n.NODE,n.SKIN,n.MESH,n.CAMERA,n.PRIMITIVE,n.PRIMITIVE_TARGET,n.ANIMATION,n.MATERIAL,n.TEXTURE,n.ACCESSOR,n.BUFFER],keepLeaves:!1},Me=function(e=Ne){const t=B({},Ne,e),r=new Set(t.propertyTypes);return F("prune",e=>{const s=e.getLogger(),i=e.getRoot(),a=e.getGraph(),c={};if(r.has(n.NODE)&&!t.keepLeaves&&i.listScenes().forEach(function e(t){if(t.listChildren().forEach(e),t instanceof u)return;const r=a.listParentEdges(t).some(e=>{const t=e.getParent().propertyType;return t!==n.ROOT&&t!==n.SCENE&&t!==n.NODE});0!==a.listChildren(t).length||r||(t.dispose(),p(t))}),r.has(n.NODE)&&i.listNodes().forEach(l),r.has(n.SKIN)&&i.listSkins().forEach(l),r.has(n.MESH)&&i.listMeshes().forEach(l),r.has(n.CAMERA)&&i.listCameras().forEach(l),r.has(n.PRIMITIVE)&&f(a,n.PRIMITIVE),r.has(n.PRIMITIVE_TARGET)&&f(a,n.PRIMITIVE_TARGET),r.has(n.ANIMATION))for(const e of i.listAnimations()){for(const t of e.listChannels())t.getTargetNode()||(t.dispose(),p(t));if(e.listChannels().length)e.listSamplers().forEach(l);else{const t=e.listSamplers();l(e),t.forEach(l)}}if(r.has(n.MATERIAL)&&i.listMaterials().forEach(l),r.has(n.TEXTURE)&&i.listTextures().forEach(l),r.has(n.ACCESSOR)&&i.listAccessors().forEach(l),r.has(n.BUFFER)&&i.listBuffers().forEach(l),Object.keys(c).length){const e=Object.keys(c).map(e=>`${e} (${c[e]})`).join(", ");s.info(`prune: Removed types... ${e}`)}else s.info("prune: No unused properties found.");function l(e){e.listParents().filter(e=>!(e instanceof o||e instanceof g)).length||(e.dispose(),p(e))}function f(e,t){e.listEdges().map(e=>e.getParent()).filter(e=>e.propertyType===t).forEach(l)}function p(e){c[e.propertyType]=c[e.propertyType]||0,c[e.propertyType]++}s.debug("prune: Complete.")})},Re={target:"size"};function Oe(t){const r=B({},Re,t),o=r.encoder;if(!o)throw new Error('reorder: encoder dependency required — install "meshoptimizer".');return F("reorder",async t=>{const s=t.getLogger();await o.ready;const i=Ce(t);for(const t of i.indicesToAttributes.keys()){const n=t.clone();let s=n.getArray().slice();s instanceof Uint32Array||(s=new Uint32Array(s));const[a,c]=o.reorderMesh(s,i.indicesToMode.get(t)===e.Mode.TRIANGLES,"size"===r.target);n.setArray(c<=65534?new Uint16Array(s):s);for(const e of i.indicesToAttributes.get(t)){const r=e.clone();J(r,a,c);for(const o of i.attributesToPrimitives.get(e))if(o.getIndices()===t&&o.swap(t,n),o.getIndices()===n){o.swap(e,r);for(const t of o.listTargets())t.swap(e,r)}}}await t.transform(Me({propertyTypes:[n.ACCESSOR]})),i.indicesToAttributes.size?s.debug("reorder: Complete."):s.warn("reorder: No qualifying primitives found; may need to weld first.")})}function Ce(e){const t=new H,n=new Map,r=new H;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives()){const o=e.getIndices();if(o){n.set(o,e.getMode());for(const n of X(e))t.add(o,n),r.add(n,e)}}return{indicesToAttributes:t,indicesToMode:n,attributesToPrimitives:r}}function Pe(e,t=Infinity){if(Number.isFinite(t)&&t%4||t<=0)throw new Error("Limit must be positive multiple of four.");const n=e.getAttribute("POSITION").getCount(),r=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,o=new Uint16Array(4*r),s=new Float32Array(4*r),i=new Float32Array(4*r),a=new Uint32Array(4*r),l=new Uint32Array(4*r);for(let t=0;t<n;t++){xe(e,t,"WEIGHTS",s),xe(e,t,"JOINTS",a);for(let e=0;e<4*r;e++)o[e]=e;o.sort((e,t)=>s[e]>s[t]?-1:1);for(let e=0;e<o.length;e++)i[e]=s[o[e]],l[e]=a[o[e]];ze(e,t,"WEIGHTS",i),ze(e,t,"JOINTS",l)}for(let n=r;4*n>t;n--){const t=e.getAttribute("WEIGHTS_"+(n-1)),r=e.getAttribute("JOINTS_"+(n-1));e.setAttribute("WEIGHTS_"+(n-1),null),e.setAttribute("JOINTS_"+(n-1),null),1===t.listParents().length&&t.dispose(),1===r.listParents().length&&r.dispose()}!function(e){if(!function(e){const t=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).map(t=>e.getAttribute(t)),n=t.map(e=>e.getNormalized()),r=t.map(e=>e.getComponentType());return 1===new Set(n).size&&1===new Set(r).size}(e))return;const t=e.getAttribute("POSITION").getCount(),n=e.listSemantics().filter(e=>e.startsWith("WEIGHTS_")).length,r=e.getAttribute("WEIGHTS_0"),o=r.getArray(),s=r.getComponentType(),i=r.getNormalized(),a=i?c.denormalize(1,s):Number.EPSILON,l=o.slice(0,4*n).fill(0);for(let n=0;n<t;n++){xe(e,n,"WEIGHTS",l);let t=$e(l);if(0!==t){if(Math.abs(1-t)>a)for(let e=0;e<l.length;e++)if(i){const n=c.normalize(l[e]/t,s);l[e]=c.denormalize(n,s)}else l[e]/=t;if(t=$e(l),i&&1!==t)for(let e=l.length-1;e>=0;e--)if(l[e]>0){l[e]+=1-t;break}ze(e,n,"WEIGHTS",l)}}}(e)}function xe(e,t,n,r){let o;const s=[0,0,0,0];for(let i=0;o=e.getAttribute(`${n}_${i}`);i++){o.getElement(t,s);for(let e=0;e<4;e++)r[4*i+e]=s[e]}return r}function ze(e,t,n,r){let o;const s=[0,0,0,0];for(let i=0;o=e.getAttribute(`${n}_${i}`);i++){for(let e=0;e<4;e++)s[e]=r[4*i+e];o.setElement(t,s)}}function $e(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t}const ve=[Int8Array,Int16Array,Int32Array],{TRANSLATION:Le,ROTATION:_e,SCALE:qe,WEIGHTS:Ge}=g.TargetPath,ke=[Le,_e,qe],Be={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0},Fe=(e=Be)=>{const t=B({},Be,e);return F("quantize",async e=>{const r=e.getLogger(),o=e.getRoot();let s;e.createExtension(E).setRequired(!0),"scene"===t.quantizationVolume&&(s=We(function(e){const t=e[0];for(const n of e)$(t.min,t.min,n.min),L(t.max,t.max,n.max);return t}(o.listMeshes().map(Ke))));for(const n of e.getRoot().listMeshes()){"mesh"===t.quantizationVolume&&(s=We(Ke(n))),s&&t.pattern.test("POSITION")&&(He(e,n,s),Ve(n,1/s.scale));for(const r of n.listPrimitives()){Ue(e,r,s,t);for(const n of r.listTargets())Ue(e,n,s,t)}}await e.transform(Me({propertyTypes:[n.ACCESSOR,n.SKIN,n.MATERIAL]}),re({propertyTypes:[n.ACCESSOR,n.MATERIAL]})),r.debug("quantize: Complete.")})};function Ue(t,n,r,o){const s=t.getLogger();for(const t of n.listSemantics()){if(!o.pattern.test(t))continue;const i=n.getAttribute(t),{bits:a,ctor:c}=Xe(t,i,s,o);if(!c)continue;if(a<8||a>16)throw new Error("quantize: Requires bits = 8–16.");if(i.getComponentSize()<=a/8)continue;const l=i.clone();if("POSITION"===t){const t=r.scale,o=[];n instanceof e?O(o,Ze(r)):P(o,[1/t,1/t,1/t]);for(let e=0,t=[0,0,0],n=l.getCount();e<n;e++)l.getElement(e,t),l.setElement(e,z(t,t,o))}De(l,c,a),n.swap(i,l)}if(o.normalizeWeights&&n.getAttribute("WEIGHTS_0")&&Pe(n,Infinity),n instanceof e&&n.getIndices()&&n.listAttributes().length&&n.listAttributes()[0].getCount()<65535){const e=n.getIndices();e.setArray(new Uint16Array(e.getArray()))}}function We(e){const{min:t,max:n}=e,r=Math.max((n[0]-t[0])/2,(n[1]-t[1])/2,(n[2]-t[2])/2);return{offset:[t[0]+(n[0]-t[0])/2,t[1]+(n[1]-t[1])/2,t[2]+(n[2]-t[2])/2],scale:r}}function He(e,t,n){const r=Ze(n);for(const o of t.listParents()){if(!(o instanceof l))continue;const s=o.listParents().filter(e=>e instanceof g),i=s.some(e=>ke.includes(e.getTargetPath())),a=o.listChildren().length>0;if(o.getSkin()){o.setSkin(je(o.getSkin(),n));continue}let c;a||i?(c=e.createNode("").setMesh(t),o.addChild(c).setMesh(null),s.filter(e=>e.getTargetPath()===Ge).forEach(e=>e.setTargetNode(c))):c=o;const u=c.getMatrix();x(u,u,r),c.setMatrix(u)}}function je(e,t){e=e.clone();const n=Ze(t),r=e.getInverseBindMatrices().clone(),o=[];for(let e=0,t=r.getCount();e<t;e++)r.getElement(e,o),x(o,o,n),r.setElement(e,o);return e.setInverseBindMatrices(r)}function Ve(e,t){for(const n of e.listPrimitives()){let e=n.getMaterial();if(!e)continue;let r=e.getExtension("KHR_materials_volume");!r||r.getThicknessFactor()<=0||(r=r.clone().setThicknessFactor(r.getThicknessFactor()*t),e=e.clone().setExtension("KHR_materials_volume",r),n.setMaterial(e))}}function De(e,t,n){const r=new t(e.getArray().length),o=ve.includes(t)?1:0,s=n-o,i=8*t.BYTES_PER_ELEMENT-o,a=Math.pow(2,s)-1,c=i-s,l=2*s-i;for(let t=0,n=0,o=[];t<e.getCount();t++){e.getElement(t,o);for(let e=0;e<o.length;e++){let t=Math.round(Math.abs(o[e])*a);t=t<<c|t>>l,r[n++]=t*Math.sign(o[e])}}e.setArray(r).setNormalized(!0)}function Xe(e,t,n,r){const o=t.getMinNormalized([]),s=t.getMaxNormalized([]);let i,a;if("POSITION"===e)i=r.quantizePosition,a=i<=8?Int8Array:Int16Array;else if("NORMAL"===e||"TANGENT"===e)i=r.quantizeNormal,a=i<=8?Int8Array:Int16Array;else if(e.startsWith("COLOR_"))i=r.quantizeColor,a=i<=8?Uint8Array:Uint16Array;else if(e.startsWith("TEXCOORD_")){if(o.some(e=>e<0)||s.some(e=>e>1))return n.warn(`quantize: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=r.quantizeTexcoord,a=i<=8?Uint8Array:Uint16Array}else{if(e.startsWith("JOINTS_"))return i=Math.max(...t.getMax([]))<=255?8:16,a=i<=8?Uint8Array:Uint16Array,t.getComponentSize()>i/8&&t.setArray(new a(t.getArray())),{bits:-1};if(e.startsWith("WEIGHTS_")){if(o.some(e=>e<0)||s.some(e=>e>1))return n.warn(`quantize: Skipping ${e}; out of [0,1] range.`),{bits:-1};i=r.quantizeWeight,a=i<=8?Uint8Array:Uint16Array}else{if(!e.startsWith("_"))throw new Error(`quantize: Unexpected semantic, "${e}".`);if(o.some(e=>e<-1)||s.some(e=>e>1))return n.warn(`quantize: Skipping ${e}; out of [-1,1] range.`),{bits:-1};i=r.quantizeGeneric,a=a=o.some(e=>e<0)?i<=8?Int8Array:Int16Array:i<=8?Uint8Array:Uint16Array}}return{bits:i,ctor:a}}function Ke(e){const t=[],n=[];for(const r of e.listPrimitives()){const e=r.getAttribute("POSITION");e&&t.push(e);for(const e of r.listTargets()){const t=e.getAttribute("POSITION");t&&n.push(t)}}if(0===t.length)throw new Error('quantize: Missing "POSITION" attribute.');const r=Je(t,3);if(n.length>0){const{min:e,max:t}=Je(n,3);$(r.min,r.min,$(e,v(e,e,2),[0,0,0])),L(r.max,r.max,L(t,v(t,t,2),[0,0,0]))}return r}function Je(e,t){const n=new Array(t).fill(Infinity),r=new Array(t).fill(-Infinity),o=[],s=[];for(const i of e){i.getMinNormalized(o),i.getMaxNormalized(s);for(let e=0;e<t;e++)n[e]=Math.min(n[e],o[e]),r[e]=Math.max(r[e],s[e])}return{min:n,max:r}}function Ze(e){return C([],[0,0,0,1],e.offset,[e.scale,e.scale,e.scale])}const Qe={level:"high"},Ye=e=>{const t=B({},Qe,e),n=t.encoder;if(!n)throw new Error('meshopt: encoder dependency required — install "meshoptimizer".');return async e=>{await e.transform(Oe({encoder:n,target:"size"}),Fe({pattern:"medium"===t.level?/.*/:/^(POSITION|TEXCOORD|JOINTS|WEIGHTS)(_\d+)?$/,quantizePosition:14,quantizeTexcoord:12,quantizeColor:8,quantizeNormal:8})),e.createExtension(I).setRequired(!0).setEncoderOptions({method:"medium"===t.level?I.EncoderMethod.QUANTIZE:I.EncoderMethod.FILTER})}},et={};function tt(e=et){return B({},et,e),F("metalRough",async e=>{const t=e.getLogger();if(!e.getRoot().listExtensionsUsed().map(e=>e.extensionName).includes("KHR_materials_pbrSpecularGlossiness"))return void t.warn("metalRough: KHR_materials_pbrSpecularGlossiness not found on document.");const n=e.createExtension(b),r=e.createExtension(w),o=e.createExtension(N),s=new Set;for(const t of e.getRoot().listMaterials()){const o=t.getExtension("KHR_materials_pbrSpecularGlossiness");if(!o)continue;const i=r.createSpecular().setSpecularFactor(1).setSpecularColorFactor(o.getSpecularFactor());s.add(o.getSpecularGlossinessTexture()),s.add(t.getBaseColorTexture()),s.add(t.getMetallicRoughnessTexture()),t.setBaseColorFactor(o.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",n.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",i);const a=o.getDiffuseTexture();a&&(t.setBaseColorTexture(a),t.getBaseColorTextureInfo().copy(o.getDiffuseTextureInfo()));const c=o.getSpecularGlossinessTexture();if(c){const n=o.getSpecularGlossinessTextureInfo(),r=e.createTexture();await W(c,r,(e,t,n)=>{e.set(t,n,3,255)}),i.setSpecularTexture(r),i.setSpecularColorTexture(r),i.getSpecularTextureInfo().copy(n),i.getSpecularColorTextureInfo().copy(n);const s=o.getGlossinessFactor(),a=e.createTexture();await W(c,a,(e,t,n)=>{const r=255-Math.round(e.get(t,n,3)*s);e.set(t,n,0,0),e.set(t,n,1,r),e.set(t,n,2,0),e.set(t,n,3,255)}),t.setMetallicRoughnessTexture(a),t.getMetallicRoughnessTextureInfo().copy(n)}else i.setSpecularColorFactor(o.getSpecularFactor()),t.setRoughnessFactor(1-o.getGlossinessFactor());t.setExtension("KHR_materials_pbrSpecularGlossiness",null)}o.dispose();for(const e of s)e&&1===e.listParents().length&&e.dispose();t.debug("metalRough: Complete.")})}const nt={};function rt(e=nt){return B({},nt,e),F("unweld",e=>{const t=e.getLogger(),n=new Map;for(const r of e.getRoot().listMeshes())for(const e of r.listPrimitives()){const r=e.getIndices();if(!r)continue;const o=e.getAttribute("POSITION").getCount();for(const o of e.listAttributes())e.swap(o,ot(o,r,t,n)),1===o.listParents().length&&o.dispose();for(const o of e.listTargets())for(const e of o.listAttributes())o.swap(e,ot(e,r,t,n)),1===e.listParents().length&&e.dispose();const s=e.getAttribute("POSITION").getCount();t.debug(`unweld: ${D(o,s)} vertices.`),e.setIndices(null),1===r.listParents().length&&r.dispose()}t.debug("unweld: Complete.")})}function ot(e,t,n,r){if(r.has(e)&&r.get(e).has(t))return n.debug(`unweld: Cache hit for reused attribute, "${e.getName()}".`),r.get(e).get(t);const o=e.clone(),s=e.getArray().constructor;o.setArray(new s(t.getCount()*e.getElementSize()));const i=[];for(let n=0;n<t.getCount();n++)o.setElement(n,e.getElement(t.getScalar(n),i));return r.has(e)||r.set(e,new Map),r.get(e).set(t,o),o}const st={overwrite:!1};function it(e=st){const t=B({},st,e);return F("normals",async e=>{const n=e.getLogger();let r=0;await e.transform(rt());for(const o of e.getRoot().listMeshes())for(const s of o.listPrimitives()){const o=s.getAttribute("POSITION");let i=s.getAttribute("NORMAL");if(t.overwrite&&i)i.dispose();else if(i){n.debug("normals: Skipping primitive: NORMAL found.");continue}i=e.createAccessor().setArray(new Float32Array(3*o.getCount())).setType("VEC3");const a=[0,0,0],c=[0,0,0],l=[0,0,0];for(let e=0;e<o.getCount();e+=3){o.getElement(e+0,a),o.getElement(e+1,c),o.getElement(e+2,l);const t=at(a,c,l);i.setElement(e+0,t),i.setElement(e+1,t),i.setElement(e+2,t)}s.setAttribute("NORMAL",i),r++}r?n.debug("normals: Complete."):n.warn("normals: No qualifying primitives found. See debug output.")})}function at(e,t,n){const r=[t[0]-e[0],t[1]-e[1],t[2]-e[2]],o=[n[0]-e[0],n[1]-e[1],n[2]-e[2]];return _([0,0,0],[r[1]*o[2]-r[2]*o[1],r[2]*o[0]-r[0]*o[2],r[0]*o[1]-r[1]*o[0]])}const ct={animations:!0,meshes:!0},lt=(e=ct)=>{const t=B({},ct,e);return F("partition",async e=>{const r=e.getLogger();!1!==t.meshes&&function(e,t,n){const r=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listMeshes().forEach((o,s)=>{if(Array.isArray(n.meshes)&&!n.meshes.includes(o.getName()))return void t.debug(`partition: Skipping mesh #${s} with name "${o.getName()}".`);t.debug(`partition: Creating buffer for mesh "${o.getName()}".`);const i=e.createBuffer(o.getName()).setURI(gt(o.getName()||"mesh",r));o.listPrimitives().forEach(e=>{const t=e.getIndices();t&&t.setBuffer(i),e.listAttributes().forEach(e=>e.setBuffer(i)),e.listTargets().forEach(e=>{e.listAttributes().forEach(e=>e.setBuffer(i))})})})}(e,r,t),!1!==t.animations&&function(e,t,n){const r=new Set(e.getRoot().listBuffers().map(e=>e.getURI()));e.getRoot().listAnimations().forEach((o,s)=>{if(Array.isArray(n.animations)&&!n.animations.includes(o.getName()))return void t.debug(`partition: Skipping animation #${s} with name "${o.getName()}".`);t.debug(`partition: Creating buffer for animation "${o.getName()}".`);const i=e.createBuffer(o.getName()).setURI(gt(o.getName()||"animation",r));o.listSamplers().forEach(e=>{const t=e.getInput(),n=e.getOutput();t&&t.setBuffer(i),n&&n.setBuffer(i)})})}(e,r,t),t.meshes||t.animations||r.warn("partition: Select animations or meshes to create a partition."),await e.transform(Me({propertyTypes:[n.BUFFER]})),r.debug("partition: Complete.")})};function gt(e,t){let n=`${e}.bin`,r=1;for(;t.has(n);)n=`${e}_${r++}.bin`;return n}const ut={tolerance:1e-4},ft=(e=ut)=>{const t=B({},ut,e);return F("resample",(e,n)=>{const r=new Set,s=e.getRoot().listAccessors().length,i=e.getLogger();let a=!1;for(const n of e.getRoot().listAnimations()){const e=new Set;for(const t of n.listChannels())t.getSampler()&&"weights"===t.getTargetPath()&&e.add(t.getSampler());for(const o of n.listSamplers())e.has(o)?a=!0:"STEP"!==o.getInterpolation()&&"LINEAR"!==o.getInterpolation()||(r.add(o.getInput()),r.add(o.getOutput()),pt(o,t))}for(const e of Array.from(r.values()))e.listParents().some(e=>!(e instanceof o))||e.dispose();e.getRoot().listAccessors().length>s&&!U(n,"resample","dedup")&&i.warn('resample: Resampling required copying accessors, some of which may be duplicates. Consider using "dedup" to consolidate any duplicates.'),a&&i.warn("resample: Skipped optimizing morph target keyframes, not yet supported."),i.debug("resample: Complete.")})};function pt(e,t){const n=e.getInput().clone(),r=e.getOutput().clone(),o=t.tolerance,s=n.getCount()-1,i=[];let a=1;for(let t=1;t<s;++t){const s=n.getScalar(t),l=n.getScalar(t-1),g=n.getScalar(t+1),u=(s-l)/(g-l);let f=!1;if(s!==g&&(1!==t||s!==n.getScalar(0)))for(let n=0;n<r.getElementSize();n++){const s=r.getElement(t,i)[n],a=r.getElement(t-1,i)[n],l=r.getElement(t+1,i)[n];if("LINEAR"===e.getInterpolation()){if(Math.abs(s-(a*(1-(c=u))+l*c))>o){f=!0;break}}else if("STEP"===e.getInterpolation()&&(s!==a||s!==l)){f=!0;break}}f&&(t!==a&&(n.setScalar(a,n.getScalar(t)),r.setElement(a,r.getElement(t,i))),a++)}var c;s>0&&(n.setScalar(a,n.getScalar(s)),r.setElement(a,r.getElement(s,i)),a++),a!==n.getCount()?(n.setArray(n.getArray().slice(0,a)),r.setArray(r.getArray().slice(0,a*r.getElementSize())),e.setInput(n),e.setOutput(r)):(n.dispose(),r.dispose())}const mt={name:"",fps:10,pattern:/.*/,sort:!0};function dt(e=mt){const t=B({},mt,e);return F("sequence",e=>{const n=e.getLogger(),r=e.getRoot(),o=t.fps,s=r.listNodes().filter(e=>e.getName().match(t.pattern));t.sort&&s.sort((e,t)=>e.getName()>t.getName()?1:-1);const i=e.createAnimation(t.name),a=r.listBuffers()[0];s.forEach((t,n)=>{let r,c;0===n?(r=[n/o,(n+1)/o],c=[1,1,1,0,0,0]):n===s.length-1?(r=[(n-1)/o,n/o],c=[0,0,0,1,1,1]):(r=[(n-1)/o,n/o,(n+1)/o],c=[0,0,0,1,1,1,0,0,0]);const l=e.createAccessor().setArray(new Float32Array(r)).setBuffer(a),u=e.createAccessor().setArray(new Float32Array(c)).setBuffer(a).setType(f.Type.VEC3),m=e.createAnimationSampler().setInterpolation(p.Interpolation.STEP).setInput(l).setOutput(u),d=e.createAnimationChannel().setTargetNode(t).setTargetPath(g.TargetPath.SCALE).setSampler(m);i.addSampler(m).addChannel(d)}),n.debug("sequence: Complete.")})}const ht={tolerance:1e-4,overwrite:!0};function At(t=ht){const r=B({},ht,t);if(r.tolerance>.1||r.tolerance<0)throw new Error("weld: Requires 0 ≤ tolerance ≤ 0.1");return F("weld",async(t,o)=>{const s=t.getLogger();for(const n of t.getRoot().listMeshes())for(const o of n.listPrimitives())o.getIndices()&&!r.overwrite||o.getMode()!==e.Mode.POINTS&&(0===r.tolerance?yt(t,o):Et(t,o,r));U(o,"weld","dedup")||await t.transform(re({propertyTypes:[n.ACCESSOR]})),s.debug("weld: Complete.")})}function yt(e,t){if(t.getIndices())return;const n=t.listAttributes()[0],r=n.getCount(),o=n.getBuffer(),s=r<=65534?new Uint16Array(r):new Uint32Array(r),i=e.createAccessor().setBuffer(o).setType(f.Type.SCALAR).setArray(s);for(let e=0;e<i.getCount();e++)i.setScalar(e,e);t.setIndices(i)}function Et(e,t,n){const r=e.getLogger(),o=t.getAttribute("POSITION"),s=t.getIndices()||e.createAccessor().setArray(Z(o.getCount())),i=new Uint32Array(new Set(s.getArray())),a=Math.max(n.tolerance,Number.EPSILON),c={};for(const e of t.listSemantics()){const n=t.getAttribute(e);c[e]=bt(e,n,a)}var l;r.debug(`weld: Tolerance thresholds: ${l=c,Object.entries(l).map(([e,t])=>`${e}=${t}`).join(", ")}`);const g=[0,0,0],u=[0,0,0];i.sort((e,t)=>(o.getElement(e,g),o.getElement(t,u),g[0]>u[0]?1:-1));const f=Z(i.length),p=Z(i.length),m=o.getCount();let d=0,h=0;for(let e=0;e<i.length;e++){const n=i[e];for(let r=e-1;r>=0;r--){const e=f[i[r]];if(o.getElement(n,g),o.getElement(e,u),Math.abs(g[0]-u[0])>c.POSITION)break;h++;const s=t.listSemantics().every(r=>wt(t.getAttribute(r),n,e,c[r])),a=t.listTargets().every(r=>r.listSemantics().every(r=>wt(t.getAttribute(r),n,e,c[r])));if(s&&a){f[n]=e;break}}p[n]=f[n]===n?d++:p[f[n]]}r.debug(`weld: Iterations per vertex: ${Math.round(h/i.length)} (avg)`),r.debug(`weld: ${D(m,d)} vertices.`);const A=s.getCount(),y=Z(A,i.length);for(let e=0;e<A;e++)y[e]=p[s.getScalar(e)];t.setIndices(s.clone().setArray(y)),1===s.listParents().length&&s.dispose();for(const e of t.listAttributes())Tt(t,e,p,d);for(const e of t.listTargets())for(const t of e.listAttributes())Tt(e,t,p,d)}function Tt(e,t,n,r){const o=(s=t.getArray(),i=r*t.getElementSize(),new(0,s.constructor)(i));var s,i;const a=t.clone().setArray(o),c=new Uint8Array(r);for(let e=0,r=[];e<n.length;e++)c[n[e]]||(a.setElement(n[e],t.getElement(e,r)),c[n[e]]=1);e.swap(t,a),1===t.listParents().length&&t.dispose()}const St=[],It=[];function bt(e,t,n){return"NORMAL"===e||"TANGENT"===e?.5:e.startsWith("COLOR_")?.01:e.startsWith("TEXCOORD_")?1e-4:e.startsWith("JOINTS_")?0:e.startsWith("WEIGHTS_")?.01:(St.length=It.length=0,t.getMinNormalized(St),t.getMaxNormalized(It),n*(Math.max(...It)-Math.min(...St)||1))}function wt(e,t,n,r,o){e.getElement(t,St),e.getElement(n,It);for(let t=0,n=e.getElementSize();t<n;t++)if(Math.abs(St[t]-It[t])>r)return!1;return!0}const Nt={ratio:.5,error:.001,lockBorder:!1},Mt=t=>{const r=B({},Nt,t),o=r.simplifier;if(!o)throw new Error('simplify: simplifier dependency required — install "meshoptimizer".');return F("simplify",async(t,s)=>{const i=t.getLogger();await o.ready,await t.transform(At({overwrite:!1}));for(const n of t.getRoot().listMeshes())for(const o of n.listPrimitives())o.getMode()===e.Mode.TRIANGLES?Rt(t,o,r):i.warn(`simplify: Skipping primitive of mesh "${n.getName()}": Requires TRIANGLES draw mode.`);U(s,"simplify","dedup")||await t.transform(re({propertyTypes:[n.ACCESSOR]})),i.debug("simplify: Complete.")})};function Rt(e,t,n){const r=B({},Nt,n),o=e.getLogger(),s=t.getAttribute("POSITION"),i=t.getIndices(),a=s.getCount();let c=s.getArray(),l=i.getArray();if(s.getComponentType()!==f.ComponentType.FLOAT)if(s.getNormalized()){const e=c,t=new Float32Array(e.length);for(let n=0,r=s.getCount(),o=[];n<r;n++)o=s.getElement(n,o),s.setArray(t).setElement(n,o).setArray(e);c=t}else c=new Float32Array(c);i.getComponentType()!==f.ComponentType.UNSIGNED_INT&&(l=new Uint32Array(l));const g=3*Math.floor(r.ratio*a/3),[u,p]=r.simplifier.simplify(l,c,3,g,r.error,r.lockBorder?["LockBorder"]:[]),[m,d]=r.simplifier.compactMesh(u);o.debug(`simplify: ${D(s.getCount(),d)} vertices, error: ${p.toFixed(4)}.`);for(const e of X(t)){const n=e.clone();J(n,m,d),K(t,e,n),1===e.listParents().length&&e.dispose()}const h=i.clone();return h.setArray(a<=65534?new Uint16Array(u):u),t.setIndices(h),1===i.listParents().length&&i.dispose(),t}function Ot(e,t){const n=Ct(e,t),r=[];return n&d.R&&r.push(d.R),n&d.G&&r.push(d.G),n&d.B&&r.push(d.B),n&d.A&&r.push(d.A),r}function Ct(e,t){let r=0;for(const o of e.getGraph().listParentEdges(t)){const t=o.getParent();let{channels:s}=o.getAttributes();s&&"baseColorTexture"===o.getName()&&t instanceof m&&t.getAlphaMode()===m.AlphaMode.OPAQUE&&(s&=~d.A),s?r|=s:t.propertyType!==n.ROOT&&e.getLogger().warn(`Missing attribute ".channels" on edge, "${o.getName()}".`)}return r}function Pt(e,t){const n=e.getRoot(),r=e.getGraph().listParentEdges(t).filter(e=>e.getParent()!==n).map(e=>e.getName());return Array.from(new Set(r))}var xt;!function(e){e.OXIPNG="oxipng",e.MOZJPEG="mozjpeg",e.WEBP="webp"}(xt||(xt={}));const zt={[xt.OXIPNG]:"image/png",[xt.MOZJPEG]:"image/jpeg",[xt.WEBP]:"image/webp"},$t={jobs:4,formats:/.*/,slots:/.*/,auto:!1},vt=B({},$t,{codec:xt.WEBP}),Lt=B({},$t,{codec:xt.MOZJPEG,formats:/^image\/jpeg$/}),_t=B({},$t,{codec:xt.OXIPNG,formats:/^image\/png$/}),qt=["image/jpeg","image/png","image/webp"];let Gt=null,kt=0;const Bt=(e,t)=>(Gt||(Gt=new e.ImagePool(t)),kt++,Gt),Ft=()=>{kt--,Gt&&kt<=0&&(Gt.close(),Gt=null)},Ut=function(e){const t=B({},$t,e),n=t.squoosh,r=t.codec;if(!n)throw new Error(`${r}: squoosh dependency required — install "@squoosh/lib".`);return async e=>{const o=e.getLogger(),s=e.getRoot().listTextures(),i=Bt(n,t.jobs);await Promise.all(s.map(async(n,s)=>{const a=Pt(e,n),c=Ct(e,n),l=n.getURI()||n.getName()||`${s+1}/${e.getRoot().listTextures().length}`,g=`${r}:texture(${l})`;if(!qt.includes(n.getMimeType()))return void o.debug(`${g}: Skipping, unsupported texture type "${n.getMimeType()}".`);if(!t.formats.test(n.getMimeType()))return void o.debug(`${g}: Skipping, "${n.getMimeType()}" excluded by "formats" parameter.`);if(a.length&&!a.some(e=>t.slots.test(e)))return void o.debug(`${g}: Skipping, [${a.join(", ")}] excluded by "slots" parameter.`);if(t.codec===xt.MOZJPEG&&c&d.A)return void o.warn(`${g}: Skipping, [${a.join(", ")}] requires alpha channel.`);o.debug(`${g}: Slots → [${a.join(", ")}]`);const u=i.ingestImage(n.getImage()),f=n.getImage().byteLength;await u.encode({[t.codec]:t.auto?"auto":{}});const p=await u.encodedWith[t.codec];o.debug(`${g}: ${JSON.stringify(p.optionsUsed)}`),n.setImage(p.binary).setMimeType(zt[t.codec]);const m=p.binary.byteLength;o.debug(`${g}: ${j(f)} → ${j(m)}`)})),Ft(),o.debug(`${r}: Complete.`)}},Wt=function(e){const t=B({},vt,e);return async e=>{await Ut(t)(e),e.getRoot().listTextures().some(e=>e.getMimeType()===zt[xt.WEBP])&&e.createExtension(M).setRequired(!0)}},Ht=function(e){const t=B({},Lt,e);return e=>Ut(t)(e)},jt=function(e){const t=B({},_t,e);return e=>Ut(t)(e)},Vt={overwrite:!1};function Dt(e=Vt){if(!e.generateTangents)throw new Error('tangents: generateTangents callback required — install "mikktspace".');const t=B({},Vt,e);return F("tangents",e=>{const n=e.getLogger(),r=new Map,o=new Map;let s=0;for(const i of e.getRoot().listMeshes()){const a=i.getName(),c=i.listPrimitives();for(let i=0;i<c.length;i++){const l=c[i];if(!Kt(l,n,a,i,t.overwrite))continue;const g=Xt(l),u=l.getAttribute("POSITION").getArray(),f=l.getAttribute("NORMAL").getArray(),p=l.getAttribute(g).getArray(),m=r.get(u)||h();r.set(u,m);const d=r.get(f)||h();r.set(f,d);const A=r.get(p)||h();r.set(p,A);const y=l.getAttribute("TANGENT");y&&2===y.listParents().length&&y.dispose();const E=`${m}|${d}|${A}`;let T=o.get(E);if(T){n.debug(`tangents: Found cache for primitive ${i} of mesh "${a}".`),l.setAttribute("TANGENT",T),s++;continue}n.debug(`tangents: Generating for primitive ${i} of mesh "${a}".`);const S=l.getAttribute("POSITION").getBuffer(),I=t.generateTangents(u instanceof Float32Array?u:new Float32Array(u),f instanceof Float32Array?f:new Float32Array(f),p instanceof Float32Array?p:new Float32Array(p));for(let e=3;e<I.length;e+=4)I[e]*=-1;T=e.createAccessor().setBuffer(S).setArray(I).setType("VEC4"),l.setAttribute("TANGENT",T),o.set(E,T),s++}}s?n.debug("tangents: Complete."):n.warn("tangents: No qualifying primitives found. See debug output.")})}function Xt(e){const t=e.getMaterial();if(!t)return"TEXCOORD_0";const n=t.getNormalTextureInfo();if(!n)return"TEXCOORD_0";const r=`TEXCOORD_${n.getTexCoord()}`;return e.getAttribute(r)?r:"TEXCOORD_0"}function Kt(t,n,r,o,s){return t.getMode()===e.Mode.TRIANGLES&&t.getAttribute("POSITION")&&t.getAttribute("NORMAL")&&t.getAttribute("TEXCOORD_0")?t.getAttribute("TANGENT")&&!s?(n.debug(`tangents: Skipping primitive ${o} of mesh "${r}": TANGENT found.`),!1):!t.getIndices()||(n.warn(`tangents: Skipping primitive ${o} of mesh "${r}": primitives must be unwelded.`),!1):(n.debug(`tangents: Skipping primitive ${o} of mesh "${r}": primitives must have attributes=[POSITION, NORMAL, TEXCOORD_0] and mode=TRIANGLES.`),!1)}const Jt="textureResize";var Zt;!function(e){e.LANCZOS3="lanczos3",e.LANCZOS2="lanczos2"}(Zt||(Zt={}));const Qt={size:[2048,2048],filter:Zt.LANCZOS3,pattern:null,slots:null};function Yt(e=Qt){const t=B({},Qt,e);return F(Jt,async e=>{const n=e.getLogger();for(const r of e.getRoot().listTextures()){const o=r.getName(),s=r.getURI();if(t.pattern&&!t.pattern.test(o)&&!t.pattern.test(s)){n.debug(`${Jt}: Skipping, excluded by "pattern" parameter.`);continue}if("image/png"!==r.getMimeType()&&"image/jpeg"!==r.getMimeType()){n.warn(`${Jt}: Skipping, unsupported texture type "${r.getMimeType()}".`);continue}const i=Pt(e,r);if(t.slots&&!i.some(e=>{var n;return null==(n=t.slots)?void 0:n.test(e)})){n.debug(`${Jt}: Skipping, [${i.join(", ")}] excluded by "slots" parameter.`);continue}const[a,c]=t.size,[l,g]=r.getSize();if(l<=a&&g<=c){n.debug(`${Jt}: Skipping, not within size range.`);continue}let u=l,f=g;u>a&&(f=Math.floor(f*(a/u)),u=a),f>c&&(u=Math.floor(u*(c/f)),f=c);const p=r.getImage(),m=await A(p,r.getMimeType()),d=q(new Uint8Array(u*f*4),[u,f,4]);n.debug(`${Jt}: Resizing "${s||o}", ${m.shape} → ${d.shape}...`),n.debug(`${Jt}: Slots → [${i.join(", ")}]`);try{t.filter===Zt.LANCZOS3?G(m,d):k(m,d)}catch(e){if(e instanceof Error){n.warn(`${Jt}: Failed to resize "${s||o}": "${e.message}".`);continue}throw e}r.setImage(await y(d,r.getMimeType()))}n.debug(`${Jt}: Complete.`)})}const en=()=>e=>{const t=e.createExtension(R).createUnlit();e.getRoot().listMaterials().forEach(e=>{e.setExtension("KHR_materials_unlit",t)})},tn={},nn=(e=tn)=>(B({},tn,e),F("unpartition",async e=>{const t=e.getLogger(),n=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(e=>e.setBuffer(n)),e.getRoot().listBuffers().forEach((e,t)=>t>0?e.dispose():null),t.debug("unpartition: Complete.")}));export{le as DRACO_DEFAULTS,Qe as MESHOPT_DEFAULTS,Be as QUANTIZE_DEFAULTS,Nt as SIMPLIFY_DEFAULTS,Qt as TEXTURE_RESIZE_DEFAULTS,Zt as TextureResizeFilter,ht as WELD_DEFAULTS,Y as center,te as colorspace,Ce as createLayoutPlan,re as dedup,ie as dequantize,ge as draco,Ct as getTextureChannelMask,ue as inspect,Ie as instance,Ot as listTextureChannels,Pt as listTextureSlots,Ye as meshopt,tt as metalRough,Ht as mozjpeg,it as normals,jt as oxipng,lt as partition,Me as prune,Fe as quantize,Oe as reorder,ft as resample,dt as sequence,Mt as simplify,Rt as simplifyPrimitive,Pe as sortPrimitiveWeights,Ut as squoosh,Dt as tangents,Yt as textureResize,en as unlit,nn as unpartition,rt as unweld,Wt as webp,At as weld};
//# sourceMappingURL=functions.modern.js.map
